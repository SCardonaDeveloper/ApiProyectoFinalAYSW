@page "/ResponsablesPage"
@using System.Net.Http.Json
@using FrontendBlazorApi.Models
@using System.Text.Json
@using System.Text.Json.Serialization
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime jsRuntime
@rendermode InteractiveServer
@inherits PaginaAutenticada

<PageTitle>Gestión de Responsables</PageTitle>
<link href="css/PersonalizacionMD.css" rel="stylesheet" />

<div class="container-fluid py-3">
    <div class="d-flex align-items-center mb-4">
        <i class="bi bi-person-badge fs-2 text-primary me-3"></i>
        <h3 class="mb-0">Gestión de Responsables</h3>
    </div>

    <div class="mb-3 d-flex gap-2 flex-wrap">
        <button type="button" class="btn btn-outline-secondary btn-lg shadow-sm" @onclick="ProbarConexion" title="Probar conexión con la API">
            <i class="bi bi-wifi"></i>
        </button>
        <button type="button" class="btn btn-outline-primary btn-lg shadow-sm" @onclick="CargarResponsables" title="Mostrar todos los responsables">
            <i class="bi bi-list-ul"></i>
        </button>
        <button type="button" class="btn btn-outline-dark btn-lg shadow-sm" @onclick="LimpiarFormulario" title="Limpiar formulario">
            <i class="bi bi-eraser"></i>
        </button>
        <button type="button" class="btn btn-outline-info btn-lg shadow-sm" @onclick="CargarDatosReferencia" title="Actualizar listas de referencia">
            <i class="bi bi-arrow-repeat"></i>
        </button>
    </div>

    @if (!string.IsNullOrWhiteSpace(mensaje))
    {
        <div class="@claseAviso shadow-sm" role="alert">
            <i class="bi bi-info-circle me-2"></i>@mensaje
        </div>
    }

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>Formulario de Responsable</h4>
        </div>
        <div class="card-body">
            <EditForm Model="responsableActual" OnValidSubmit="GuardarSegunEstado" FormName="ResponsableForm">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label fw-bold"><i class="bi bi-hash text-primary"></i> Id</label>
                        <InputNumber class="form-control" @bind-Value="responsableActual.Id" readonly />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold"><i class="bi bi-diagram-3 text-primary"></i> Tipo Responsable</label>
                        <InputSelect class="form-select" @bind-Value="responsableActual.IdTipoResponsable">
                            <option value="0">Seleccione un tipo</option>
                            @foreach (var tr in tiposResponsable)
                            {
                                <option value="@tr.Id">@tr.Id - @tr.Titulo</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold"><i class="bi bi-person text-primary"></i> Usuario</label>
                        <InputSelect class="form-select" @bind-Value="responsableActual.IdUsuario">
                            <option value="0">Seleccione un usuario</option>
                            @foreach (var u in usuarios)
                            {
                                <option value="@u.Id">@u.Id - @u.Email</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold"><i class="bi bi-card-text text-primary"></i> Nombre</label>
                        <InputText class="form-control" @bind-Value="responsableActual.Nombre" placeholder="Ingrese el nombre completo" />
                    </div>
                </div>

                <div class="mt-4 d-flex flex-wrap gap-2">
                    <button type="submit" class="btn btn-primary btn-lg shadow-sm">
                        <i class="bi bi-save"></i> @textoBotonGuardar
                    </button>
                    <button type="button" class="btn btn-danger btn-lg shadow-sm" @onclick="EliminarResponsableActual" disabled="@(!existeResponsable)">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                </div>
            </EditForm>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="bi bi-table me-2"></i>Lista de Responsables</h4>
        </div>
        <div class="card-body">
            @if (cargando)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3"><em>Cargando responsables...</em></p>
                </div>
            }
            else if (listaResponsables.Count == 0)
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>No hay responsables registrados.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-primary">
                            <tr>
                                <th><i class="bi bi-hash me-1"></i>ID</th>
                                <th><i class="bi bi-diagram-3 me-1"></i>Tipo Responsable</th>
                                <th><i class="bi bi-person me-1"></i>Usuario</th>
                                <th><i class="bi bi-card-text me-1"></i>Nombre</th>
                                <th><i class="bi bi-pencil-square me-1"></i>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var r in listaResponsables)
                            {
                                <tr>
                                    <td class="fw-bold">@r.Id</td>
                                    <td>@r.IdTipoResponsable</td>
                                    <td>@r.IdUsuario</td>
                                    <td>@r.Nombre</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary shadow-sm" @onclick="@(() => CargarEnFormulario(r))">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger shadow-sm" @onclick="@(() => EliminarResponsable(r.Id))">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<Responsables> listaResponsables = new();
    private List<TipoResponsable> tiposResponsable = new();
    private List<Usuario> usuarios = new();
    private Responsables responsableActual = new();
    private bool existeResponsable = false;
    private string textoBotonGuardar = "Crear";
    private string mensaje = "";
    private string claseAviso = "alert alert-info";
    private bool cargando = false;

    private const string urlConsultas = "api/consultas/ejecutarconsultaparametrizada";
    private const string urlProcedimientos = "api/procedimientos/ejecutarsp";

    protected override async Task OnInitializedAsync()
    {
        await CargarDatosReferencia();
        await CargarResponsables();
    }

    private async Task ProbarConexion()
    {
        try
        {
            var cliente = HttpClientFactory.CreateClient("ApiBack");
            var respuesta = await cliente.GetAsync("api/Responsable");
            mensaje = respuesta.IsSuccessStatusCode
                ? "Conexión con la API verificada."
                : $"Error de conexión: {(int)respuesta.StatusCode}";
            claseAviso = respuesta.IsSuccessStatusCode ? "alert alert-success" : "alert alert-warning";
        }
        catch (Exception ex)
        {
            mensaje = $"Error de conexión: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task CargarDatosReferencia()
    {
        await Task.WhenAll(CargarTiposResponsable(), CargarUsuarios());
    }

    private async Task CargarTiposResponsable()
    {
        try
        {
            var cliente = HttpClientFactory.CreateClient("ApiBack");
            var parametros = new Dictionary<string, object?>
            {
                ["consulta"] = "SELECT * FROM TipoResponsable ORDER BY Id",
                ["parametros"] = new Dictionary<string, object?>()
            };

            var respuesta = await cliente.PostAsJsonAsync(urlConsultas, parametros);
            var data = await respuesta.Content.ReadFromJsonAsync<RespuestaConsulta>();
            tiposResponsable = data?.Resultados?.Select(d => new TipoResponsable
            {
                Id = ObtenerInt(d, "Id"),
                Titulo = ObtenerString(d, "Titulo")
            }).ToList() ?? new();
        }
        catch { }
    }

    private async Task CargarUsuarios()
    {
        try
        {
            var cliente = HttpClientFactory.CreateClient("ApiBack");
            var parametros = new Dictionary<string, object?>
            {
                ["consulta"] = "SELECT * FROM Usuario ORDER BY Id",
                ["parametros"] = new Dictionary<string, object?>()
            };

            var respuesta = await cliente.PostAsJsonAsync(urlConsultas, parametros);
            var data = await respuesta.Content.ReadFromJsonAsync<RespuestaConsulta>();
            usuarios = data?.Resultados?.Select(d => new Usuario
            {
                Id = ObtenerInt(d, "Id"),
                Email = ObtenerString(d, "Email")
            }).ToList() ?? new();
        }
        catch { }
    }

    private async Task CargarResponsables()
    {
        cargando = true;
        try
        {
            var cliente = HttpClientFactory.CreateClient("ApiBack");
            var parametros = new Dictionary<string, object?>
            {
                ["consulta"] = "SELECT * FROM Responsable ORDER BY Id",
                ["parametros"] = new Dictionary<string, object?>()
            };

            var respuesta = await cliente.PostAsJsonAsync(urlConsultas, parametros);
            var data = await respuesta.Content.ReadFromJsonAsync<RespuestaConsulta>();
            listaResponsables = data?.Resultados?.Select(d => new Responsables
            {
                Id = ObtenerInt(d, "Id"),
                IdTipoResponsable = ObtenerInt(d, "IdTipoResponsable"),
                IdUsuario = ObtenerInt(d, "IdUsuario"),
                Nombre = ObtenerString(d, "Nombre")
            }).ToList() ?? new();

            mensaje = $"Se cargaron {listaResponsables.Count} responsable(s).";
            claseAviso = "alert alert-success";
        }
        catch (Exception ex)
        {
            mensaje = $"Error al cargar responsables: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task GuardarSegunEstado()
    {
        if (responsableActual.IdTipoResponsable <= 0)
        {
            mensaje = "Debe seleccionar un tipo de responsable válido.";
            claseAviso = "alert alert-warning";
            return;
        }
        if (responsableActual.IdUsuario <= 0)
        {
            mensaje = "Debe seleccionar un usuario válido.";
            claseAviso = "alert alert-warning";
            return;
        }
        if (string.IsNullOrWhiteSpace(responsableActual.Nombre))
        {
            mensaje = "Debe indicar un nombre.";
            claseAviso = "alert alert-warning";
            return;
        }

        if (existeResponsable)
            await ActualizarResponsable();
        else
            await CrearResponsable();
    }

    private async Task CrearResponsable()
    {
        try
        {
            var cliente = HttpClientFactory.CreateClient("ApiBack");
            var parametros = new Dictionary<string, object?>
            {
                ["nombreSP"] = "crear_responsable",
                ["IdTipoResponsable"] = responsableActual.IdTipoResponsable,
                ["IdUsuario"] = responsableActual.IdUsuario,
                ["Nombre"] = responsableActual.Nombre
            };

            var respuesta = await cliente.PostAsJsonAsync(urlProcedimientos, parametros);
            if (respuesta.IsSuccessStatusCode)
            {
                mensaje = "Responsable creado correctamente.";
                claseAviso = "alert alert-success";
                await CargarResponsables();
                LimpiarFormulario();
            }
            else
            {
                mensaje = "Error al crear responsable.";
                claseAviso = "alert alert-danger";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task ActualizarResponsable()
    {
        try
        {
            var cliente = HttpClientFactory.CreateClient("ApiBack");
            var parametros = new Dictionary<string, object?>
            {
                ["nombreSP"] = "actualizar_responsable",
                ["Id"] = responsableActual.Id,
                ["IdTipoResponsable"] = responsableActual.IdTipoResponsable,
                ["IdUsuario"] = responsableActual.IdUsuario,
                ["Nombre"] = responsableActual.Nombre
            };

            var respuesta = await cliente.PostAsJsonAsync(urlProcedimientos, parametros);
            if (respuesta.IsSuccessStatusCode)
            {
                mensaje = "Responsable actualizado correctamente.";
                claseAviso = "alert alert-success";
                await CargarResponsables();
                LimpiarFormulario();
            }
            else
            {
                mensaje = "Error al actualizar responsable.";
                claseAviso = "alert alert-danger";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private async Task EliminarResponsableActual()
    {
        if (!existeResponsable || responsableActual.Id <= 0)
        {
            mensaje = "Debe seleccionar un responsable para eliminar.";
            claseAviso = "alert alert-warning";
            return;
        }
        await EliminarResponsable(responsableActual.Id);
    }

    private async Task EliminarResponsable(int id)
    {
        bool confirmar = await jsRuntime.InvokeAsync<bool>("confirm", $"¿Eliminar responsable #{id}?");
        if (!confirmar) return;

        try
        {
            var cliente = HttpClientFactory.CreateClient("ApiBack");
            var parametros = new Dictionary<string, object?>
            {
                ["nombreSP"] = "eliminar_responsable",
                ["Id"] = id
            };

            var respuesta = await cliente.PostAsJsonAsync(urlProcedimientos, parametros);
            if (respuesta.IsSuccessStatusCode)
            {
                mensaje = "Responsable eliminado correctamente.";
                claseAviso = "alert alert-success";
                await CargarResponsables();
                LimpiarFormulario();
            }
            else
            {
                mensaje = "Error al eliminar responsable.";
                claseAviso = "alert alert-danger";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error: {ex.Message}";
            claseAviso = "alert alert-danger";
        }
    }

    private void CargarEnFormulario(Responsables r)
    {
        responsableActual = new Responsables
        {
            Id = r.Id,
            IdTipoResponsable = r.IdTipoResponsable,
            IdUsuario = r.IdUsuario,
            Nombre = r.Nombre
        };
        textoBotonGuardar = "Actualizar";
        existeResponsable = true;
    }

    private void LimpiarFormulario()
    {
        responsableActual = new Responsables();
        textoBotonGuardar = "Crear";
        existeResponsable = false;
        mensaje = "";
        claseAviso = "alert alert-info";
    }

    private int ObtenerInt(Dictionary<string, object> d, string k)
    {
        if (!d.TryGetValue(k, out var v)) return 0;
        if (v is JsonElement e && e.ValueKind == JsonValueKind.Number) return e.GetInt32();
        return Convert.ToInt32(v ?? 0);
    }

    private string ObtenerString(Dictionary<string, object> d, string k)
    {
        if (!d.TryGetValue(k, out var v)) return "";
        if (v is JsonElement e && e.ValueKind == JsonValueKind.String) return e.GetString() ?? "";
        return v?.ToString() ?? "";
    }

    private class RespuestaConsulta
    {
        [JsonPropertyName("Resultados")]
        public List<Dictionary<string, object>>? Resultados { get; set; }
    }

    public class TipoResponsable { public int Id { get; set; } public string Titulo { get; set; } = ""; }
    public class Usuario { public int Id { get; set; } public string Email { get; set; } = ""; }
}
